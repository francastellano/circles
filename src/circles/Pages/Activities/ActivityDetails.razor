@page "/activities/{ActivityId}"

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

@using circles.api.contracts.Activities.Queries

@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime

<h2>Activity</h2>


<div>
    <Message @ref="messageComponent" />
</div>

<LoadingTag Loading="@_loading" />

@if (result != null)
{
    <div>
    @result.Denomination
</div>
    <div>
        Activity Init Date
    </div>
    <div>
    @result.DateInit
</div>
    <div> Activity Location</div>
    <div>@result.LocationDenomination</div>
}
<div id="map" style="height: 400px; width: 100%;"></div>
@code {

    bool _loading;
    [Parameter, EditorRequired]
    public string ActivityId { get; set; } = string.Empty;
    private Message messageComponent = new();

    private ActivityGetByIdResults? result;
    protected override async Task OnInitializedAsync()
    {
        await JSRuntime.InvokeVoidAsync("mapInterop.loadGoogleMaps", "AIzaSyC6AB0gYGTpJJBgpMzXmaLG-Yj_ex_5rXc");
        await JSRuntime.InvokeVoidAsync("mapInterop.initMap");

        await GetDetails();
    }

    private async Task GetDetails()
    {
        try
        {
            _loading = true;
            var httpClient = HttpClientFactory.CreateClient(CirclesConfiguration.DefaultHttpClient);

            result = await
            httpClient.GetFromJsonAsync<ActivityGetByIdResults>($"api/v1/activities/{ActivityId}");

            if (result.LocationLatitude != null)
                await JSRuntime.InvokeVoidAsync("mapInterop.updateMap", result.LocationLatitude, result.LocationLongitude);
        }
        catch (Exception e)
        {
            messageComponent.ShowMessage("An error has happened while quering the activity", 5, true);
        }
        finally
        {
            _loading = false;
        }

    }

}